<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Job Listings</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: Poppins, sans-serif; background: #f6f9ff; padding: 30px; }
    .job-card {
      background: #fff; border-radius: 10px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 16px;
    }
    .job-card h3 { color: #0072ff; margin-bottom: 6px; }
    .btn-view {
      background-color: #0072ff; color: white; padding: 8px 14px;
      border-radius: 6px; text-decoration: none; display:inline-block;
    }
    .btn-view:hover { background-color: #0056cc; color: #fff; text-decoration: none; }
    .upload-form { margin-top: 12px; }
    .small-muted { color:#6c757d; font-size:0.9rem; }
  </style>
</head>
<body>
  <div class="container" style="max-width:920px;">
    <h2 class="text-primary mb-4">Top matches for "{{ skills }}" in "{{ location }}"</h2>

    {% if jobs %}
      {% for job in jobs %}
        <div class="job-card">
          <h3>{{ job.title }}</h3>
          <p><strong>{{ job.company }}</strong></p>
          {% if job.location %}
            <p class="small-muted mb-1"><i>{{ job.location }}</i></p>
          {% endif %}
          <p class="mt-3 mb-2">{{ job.summary }}</p>

          {% if job.url %}
            <a href="{{ job.url }}" target="_blank" rel="noopener noreferrer" class="btn-view" onclick="return openJob(event, '{{ job.url }}');">
              View Job on Naukri
            </a>
          {% endif %}

          <!-- Upload CV form -->
          <form onsubmit="uploadCV(event)" enctype="multipart/form-data" class="upload-form">
            <div class="row g-2 align-items-center">
              <div class="col-auto">
                <input type="file" name="resume" accept=".pdf,.doc,.docx,.txt" required class="form-control form-control-sm">
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-outline-primary btn-sm">Upload CV</button>
              </div>
              <div class="col">
                <small class="small-muted msg">Upload your resume to apply or save for this job.</small>
              </div>
            </div>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-warning">No jobs found.</div>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function openJob(event, url) {
      event.stopPropagation();
      event.preventDefault();
      window.open(url, '_blank');
      return false;
    }

    // ✅ AJAX Upload
    async function uploadCV(event) {
      event.preventDefault();
      const form = event.target;
      const msg = form.querySelector(".msg");
      const fileInput = form.querySelector("input[type=file]");
      const file = fileInput.files[0];

      if (!file) {
        msg.textContent = "⚠️ Please select a resume first.";
        msg.style.color = "red";
        return;
      }

      const formData = new FormData();
      formData.append("resume", file);

      msg.textContent = "Uploading...";
      msg.style.color = "#6c757d";

      try {
        const response = await fetch("/upload_cv", {
          method: "POST",
          body: formData,
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });

        const result = await response.json();

        if (response.ok && result.status === "success") {
          msg.textContent = "✅ " + result.message;
          msg.style.color = "green";
          fileInput.value = "";
        } else {
          msg.textContent = "❌ " + (result.message || "Upload failed.");
          msg.style.color = "red";
        }
      } catch (err) {
        msg.textContent = "❌ Server error. Try again.";
        msg.style.color = "red";
      }
    }
  </script>
</body>
</html>
